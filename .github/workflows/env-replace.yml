name: Replace Database Placeholders

permissions:
  contents: write   # âœ… allows pushing commits

on:
  push:
    branches:
      - dev
      - qat
      - prd

jobs:
  replace-env:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set database name based on branch
        run: |
          if [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "DB=DEV_CUSTOMER" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "qat" ]]; then
            echo "DB=QAT_CUSTOMER" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF_NAME}" == "prd" ]]; then
            echo "DB=PRD_CUSTOMER" >> $GITHUB_ENV
          fi

      - name: Replace placeholder in SQL files
        run: |
          echo "Using DB=$DB"
          find . -type f -name "*.sql" -exec sed -i "s/{DATABASE_CUSTOMER}/$DB/g" {} +

      - name: Commit changes back
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Auto-replaced DB placeholders for ${GITHUB_REF_NAME}" || echo "No changes"
          git push
